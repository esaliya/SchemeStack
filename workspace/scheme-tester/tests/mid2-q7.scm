;----------------------------------------------------------------
; The question
;----------------------------------------------------------------
; (f (! 1000)) runs in time t when evaluated with a call-by-value 
; interpreter, where f is defined as below and ! is factorial 
; function. How long will take to run if evaluated with a 
; call-by-need interpreter. Assume most of the time consumption
; is by the factorial calculation.

;;(define f
;;  (lambda (x)
;;    (+ x x)))


;----------------------------------------------------------------
; My answer: t/2 as I thought that (! 1000) will be evaluated
; only once with a call-by-need interpreter. Let's see :) <---------- see below for the answer :D
;----------------------------------------------------------------



;----------------------------------------------------------------
; Test macro (taken happily from the assignment itself :))
; ---------------------------------------------------------------
(define-syntax test
  (syntax-rules ()
    ((_ title tested-expression expected-result)
     (let* ((expected expected-result)
            (produced tested-expression))
       (if (equal? expected produced)
           (printf "~s works!\n" title)
           (error
            'test
            "Failed ~s: ~a\nExpected: ~a\nComputed: ~a"
            title 'tested-expression expected produced))))))

;----------------------------------------------------------------
; Call-by-value Interpreter
; ---------------------------------------------------------------
(define val-of-cbv
  (lambda (exp env)
    (pmatch exp
      [,b (guard (boolean? b)) b]
      [,n (guard (number? n)) n]
      [,x (guard (symbol? x)) (unbox (apply-env env x))]
      [(zero? ,n) (zero? (val-of-cbv n env))]
      [(sub1 ,n) (sub1 (val-of-cbv n env))]
      [(* ,n1 ,n2) (* (val-of-cbv n1 env) (val-of-cbv n2 env))]
      [(+ ,n1 ,n2) (+ (val-of-cbv n1 env) (val-of-cbv n2 env))]
      [(lambda (,x) ,body) (closure-cbv x body env)]
      [(if ,test ,conseq ,alt) (if (val-of-cbv test env)
                                   (val-of-cbv conseq env)
                                   (val-of-cbv alt env))]
      [(set! ,x ,rhs) (set-box! (apply-env env x) (val-of-cbr rhs env))]
      [(begin2 ,e1 ,e2) (begin (val-of-cbv e1 env) (val-of-cbv e2 env))]
      [(random ,n) (random n)]
      [(,rator ,rand) (apply-proc (val-of-cbv rator env)
                                  (box(val-of-cbv rand env)))])))



;----------------------------------------------------------------
; Call-by-need Interpreter
; ---------------------------------------------------------------
(define val-of-cbneed
  (lambda (exp env)
    (pmatch exp
      [,b (guard (boolean? b)) b]
      [,n (guard (number? n)) n]
      [,x (guard (symbol? x)) (unbox* (apply-env env x))]
      [(zero? ,n) (zero? (val-of-cbneed n env))]
      [(sub1 ,n) (sub1 (val-of-cbneed n env))]
      [(* ,n1 ,n2) (* (val-of-cbneed n1 env) (val-of-cbneed n2 env))]
      [(+ ,n1 ,n2) (+ (val-of-cbneed n1 env) (val-of-cbneed n2 env))]
      [(lambda (,x) ,body) (closure-cbneed x body env)]
      [(if ,test ,conseq ,alt) (if (val-of-cbneed test env)
                                   (val-of-cbneed conseq env)
                                   (val-of-cbneed alt env))]
      [(begin2 ,e1 ,e2) (begin (val-of-cbneed e1 env) (val-of-cbneed e2 env))]
      [(random ,n) (random n)]
      [(set! ,x ,rhs) (set-box! (apply-env env x) (lambda ()(val-of-cbneed rhs env)))] 
      
      [(,rator ,rand) (guard (symbol? rand)) (apply-proc (val-of-cbneed rator env)
                                  (apply-env env rand))]
      [(,rator ,rand) (apply-proc (val-of-cbneed rator env)
                                  (box (lambda () (val-of-cbneed rand env))))])))

;; The unbox* used for in the val-of-cbneed
(define unbox*
  (lambda (x-box)
    (let ([v ((unbox x-box))])
      (set-box! x-box (lambda () v))
      v)))



;----------------------------------------------------------------
; The usual suspects (helpers :))
; ---------------------------------------------------------------
(define empty-env
  (lambda ()
    (lambda (y)
      (error 'empty-env "unbound variable ~s" y))))

(define extend-env
  (lambda (env x a)
    (lambda (y) (if (eq? x y) a (apply-env env y)))))

(define apply-env
  (lambda (env x)
    (env x)))

(define apply-proc
  (lambda (p a)
    (p a)))

;; Closure for the call-by-value 
(define closure-cbv
  (lambda (x body env)
    (lambda (a) (val-of-cbv body (extend-env env x a)))))

;; Closure for the call-by-need
(define closure-cbneed
  (lambda (x body env)
    (lambda (a) (val-of-cbneed body (extend-env env x a)))))



; An attempt to write (! 10000) in a recursive way that can be understood by our interpreters
; Note: I will use 10000 instead of 1000 to get some measurable time
;;(let ([! (lambda (!)
;;           (lambda (n)
;;             (if (zero? n)
;;               1
;;               (* n ((! !) (sub1 n))))))])
;;  ((! !) 10000))

; Um, I don't like to add the let support to my interpreter now since it basically resolves to 
; a lambda call. So let's convert the let form into lambda as follows.
;;((lambda (!)
;;   ((! !) 10000))
;; (lambda (!)
;;   (lambda (n)
;;     (if (zero? n)
;;       1
;;       (* n ((! !) (sub1 n)))))))

; Now let's define my test expression, i.e. (f (! 10000)) as follows.
(define test-exp 
  '((lambda (x) (+ x x))
   ((lambda (!)
      ((! !) 10000))
    (lambda (!)
      (lambda (n)
        (if (zero? n)
          1
          (* n ((! !) (sub1 n)))))))))

; Now let's define the test result :)
(define test-result
  56925193618341090378128264242397377802961028034055984615883599885488226800075288875459815735155695516317681242846350576600846798803070374781048423227654323496396483996551848365785195757962485062411893199251973413120323144072064795852657473434111483951924198959440692307396239794185222555000968397690820951089284884273146606153407257651607097934922234194739157207340382143025461174562082317281122562330770651936851651991169376292860851179673298634118503434408553194814892266800108388104924606873738308118808132455656496743024076644357289254367645847799277985654443759404918775387606189254664585141110919380055750564485088696042255118038338850858057833814438194167381079747494904966745799043604726565482434080536173538420903111681134345110744031704265658068559979636898627221280762978608999243199998719341785960380673996968809330838472516849894326357922384082466216537302142709033691081872066019214420693888755964698861561252138844605363770455184114058461686252376995213121485172558897654311913663066881068850893296833789160851418923347226375210469964572652905843058846959741206688581474317376998357865161382966337708503912012344745272647948841573849285912024612577440245305905928183016602673261965467612707945803013163645148590951788799530227731082416251577367408478417528969523138002529778543181412612819323256077568088970383287581614372224741244266830830131983687751922047853426553093972327315413252877276059696103905539072390518481861817228943814781537171511869573963441468744186209650951257135555388163128149924550509986768225618579275033980439740984811235063572693879596049239474158083736659862033108301484616786353756733847389698051999215459368587954855072526239650833363063783526469678381642000294357864368455610270363469843802292493751539670746882912026245230442782357519376734728174415874005984076558396077404744156078280624737995216305680612102233418969444449740778399986884142791673966127924464158231248088501617839828639674240891196688095113518978424202996304909087188570828781687128839968449710957064327248060196885710663658506308413102474159411632786920592495394020777484412883073253467430857401578245498681368672885779694201681283200187247870522496075950586687857528796632780625552901444958535703401653339196779052301518014698430395185318385417746405188132764237603977709496532096684512915411487946244519401343872123527027159059643588581595410654566535002976048887057363290052331325675093038012343746884520877838597012143030780062213369454720271633412875723513514878368752959316272201199277379104669297563492286487146449728653596963962916865406071791016841069576986729164965184066576178051564776466531540410497941874094420428496826684930536413613464628428967708148364279243693740216719165893930471265529740951436703233758470136732543487423831446722286140242241535217395703119443692971971837287283433701799251033641821587140462237036349550021609245171042629529794981321505754165795335029902019364659379464001244785776113316072280622570931858168156067949801329906411746329896187767632397317701654764936069795729514233359780847136036607008267751463945261795818871421375594603267836175736949887267067786747173812811696835656130392551652868858516116844425895298805897245341523665976458008144780807466336414834826503313376886158678894038417811241576775170685025641914718614036395416680327635276557125079033650853289229882089423159066524745630937588160847437174846052400528443645388377252424214595553314802036752364560273715172884371726023079687424598214020188123858826446405546387918934013427390754195795556236576484885841729632268359124034943663219375322086280995916396472891614736418808044422363060102866774153214126299232215542234896119105528696666771488080425514063703054596754871843757117105591182057328915834724014443716286619954589557847441435885715512542601847964795843915162394529485285756533364707831375714543240292384488532533416801531331251614218948797480221545623339837612537453253131166691330015780618101312149266156054317061635382447545627021169054653183252439295241142869760431261630518010687442282000606078485732914414656946963424068336372657937730096574735866796887942473470169054680392618855395305368340349981513895965515651670459988631266644214878263100248918010649405360625824784595958060835175646797244747070109285293827005007902018478573170217364176141325469466400709991440794172976132081859709214012678819771672699730932273455761497529401404917580236093036592222554181218032304044222923086316635339914121949236170718780800135785757097655701877274707407808098825369237982545743125310002541666079900515759863410863765505318451629897901493279952014633854621663471766113225229565995326376140126089264858224521383862557763132443183046540915391735025643981877885373203927808979437837194945850620644960421087682088651656945661168595608324810216220653828003801137568792683005393042097840544280464320469797177654742857390679363510212574941814947436376028446974496997116396878189303416728737988612379300486576706559334380369055241102171415252408489019246646409489415662380868998702885251003403542034759102249492318943463725403131142532591710250155423476676416839411786734647448906560913074357029920617605160568135695618829283677318453305613735957686501321075886092500574210209858694534942534999785269254716334293870120990220681510809316340786962093516971251935535919536598818668052774538756730641824575436154902305245285097543670922217772721686545612455553286194567758113457236072097266929786742878830500518919305003041919072315954271191589931459551301805388856176959522553329694007239297812087523869388540888140430635887167662102809830925217456973357501083348293463297998712762625733862855233727074611269173253915789136550131620471901629777557910147878730683874731401696637008951364430888135198406276154147079956072678534669099098593337519845061787796172861213065923586328059224985346161276063747825192302263780718702532961637136733540573075484781493164781821911034359541161595578579504980461475603506285360727828489440515457783569900156235778673259500873608429336395648545961395158783484458913366371631353632577595741249062493303455245516590986842967317737838599174804191392000487120610579659732773784153985668061099420533028644612250463830263687753807647412410798413867887433760932859422953487128972750053695396297706210708126657690124024346605261352962645863122087103883522101424898049746554546224183891730274986381930324995383315107624397132864415957332600797877320477214715716228789431745601786748330067585931665236872146266655052047210231048454456894502927726538739527525020393428760251382455568856853998881658304431809388874564997316170410373152585985551017666257345276837426555561748893287750705289467124882278895257561949301367905964216349935917672904546689389747586943581420129956472932033361144068595858414893644645697331679044422893719145716807726754556060455183060995731747839027300492548391798176748774663188574744059541240414240426077144351866422324826660845547484832707107175954130619295371772154602865556580657789591636808757717135545864188953557338715074920096284753482388365343273740962113822312431228715032581054702448700161209307337834916393098965217224521500586125522957626537910561472298045051639365630102066636264259319329916318060842477551291981946593456133367698332515899495845810723691127482069582861543122337300968584980562205985059357470597535658538081577556960524958445501471896811634878172503755893780091884120337210285544488972544939822292400299761325447077675618761257088769526106470140264056058976784016264270892900112269974035668542212316354579638581312997376162091124467406134508502554554660566996867191545151912449407415586774293186066177259398880636665331595029353005434692597767554795696437401436053482531994317456070880956864957349814255843345797047176973887093384510202675212755830329194508514233936954679902317996698163776562527968801011092420133977585229116429130639393819654507869031520817226952517556331734588821550717648324631558165076109493867081164939435348649046902996966054340793087775475274716383473164908546694980848525892022599763833127427694223698313830109536280823499602908531424788408850882056151612002776397301227518577078077845288645895980572965680199197351927161998225390735203054346173705513144295167014244596593059129835670143501671482724565090111240541938834953598518459549777254822629175352295062913790656186234105392972820374815346593973298472874765130950045632943853631119766393259696615553333681244628631768769821038116563633481528926066600239420586072911733189303738148950501675683975245980831823587365599521308372177443253309772984688782061846513821267551939478103562245529336973583472098808787406678703801218774536794598492956967454549541954933387199569714240313578000483894538441949968254646294803099961840762919642832962352714295603108463199335677069708972813872821113827062670462368107162697881876383643797389650767921979885644055198679270412435410687144146792501148433538930203216991202878606488608543152199054617369218408844452206308459968889604220196322667649654750437997476410630329854268996211900319949601143183824404308975497500206946492381267882606061784798823970012451804368328819976346428648844217108497241792500521208796360378052635562293234909999542881330465727692727694003311236307722196376222363468382611010049720691713511171275023459548598658149888473159336665401836734677954695803518497771320759905543081138166034623447788280652319224585824450382191897487611346762557077232983685573876835113796094201719736744067230350316194045132550400321912384459850803519757044077091827543567952779622396971606582097503333842390209029793355523196498937454841326875186415705237845374571055342649766535588305825678330815936688380478189607353377415676022734085507942792402849569870393470602888808075647053348875113481766050451490547612419960902466376205458024085995978010846252435936270475516082325022918351986558268353014585653524473794583921056579350447042850468434495683738634794920823755269209251274270619603181235473517430673607917118109654723752224302769346865768650180091290716373363810217463582692431460679081161974344027688754198559065595351062198762731680807113591463788283953022872651052541279486293052696240065440193511335403852485170115541235787596462193973576897093319054654123340617836554412865103838787347182692075514166386361691859130317750489195203458911441011190171858351013020231330151043270284636307096353768392064170101742992540988035368367961165188076365187972922520551908494866752452512574307832138050197970141597321243464400327187877222950789122813271351437053234062942907033506014998427730415537047649769201247471793216109903304812961094591739837388717622395667360282976156642426914304720248131844417017825913815670741153469343335727561817622566900791569624424202234501436766718167772375149322402634596434262145889475312530344621389768850996739028294767784955484641880415662401614470652576107812532036372100849877577355744991006510848568453192542101385292143534935004675611343786900221474754068238692226748067730729350273467322789463100422914209342322890506649700395802166863283979996828090089802260327519041351431135018970487160538208155274421997343248509590770625705779861913141458437347046433332195749979270725221059642945138965599992441651551681976916968500782378895217459370369967952735836484533142334333160315829001623314384400467519530634991844795769965629411012381378551250420924371322611600511215949219453430066654064620050549280857511113093767531677605086454807014863368557241275394109583452968756348892723041141866457174568631381512511138611117637645207180013478679905008759774941870158552362232552619542515967951993053224240634991764118871509767724565016802817771441167984801942438425096148195505948557551825132052886965427294463698250361732557417252233399979269624811607369589174729640249307326457778023273144541775515472304006900204537780378203347144117322820023447329525315670792728595638023294112340559263844664588457478618466661496517875252397995193060168270766482251799279258890258165604046450997873255012999061677851264493589391921338093813372585290012439480243565799745959409718043550120185786657914544784039179988943890294721701540801451434878636296923818812539090570061052682001130044452304618729765774244092908535401154297988670294325008504730347420532137294506916240373366547907365094913073107195093371577400113976720573372901480513986174966882188172172607415816590481153463369883711620964950609517846785603142605648212469999891864781042819713119131322692006792301030329517705484429465035999097955985699045492059711333401623742401712310032914800968340420606077992678506674933113635648821474818673838588209264615463989519652614766999201540744820892570829297408232547791299669110324331370229102767644094010967993343412492935132202582764097818242234458772488506317826133974924091174489612105658756296605244329084560843515521524730919656446141631006938809876635510106610189397998952238838462561443614433928756866627213521353930374276788677544970987378123691401144087393332930161468991628991932612493397359665745172600128430440420343627834650550347344525242909890937012012669385427676623431699506185286504973920440118199605327530772450926530336829926612739096173102202513515435781233389516688086972436970739183204344060912366995048324079852882663303769537213661284009717115848946680580285177752807425037284458032667383170126547454399192725825566689572437775742019067507102109377960472756527429853826579128678881798940242904269144235431315182903469790390033601242707854350839687752327086959613841773332454199024743412483849828565152906251539879470683346093729170363959336464031387585369853999967984827143882993764547408045641610343616006800961230523584027957890372590581116881407476601067104842307806770371658733558381220232612467346288838405787714403711139192661667230900580849644618594174249576004034766144120965360313350795187579863587031599917859124312614676832589199800553461665655433190128435933046380878501086453507463623510630953561478940677862370214595448636757945349914911556366690991884634707116582093934630782551951374563723382322166312674465279937762981087886522394364549993582353257106803720396631619259963582214417609984584032124118134542547198923743269891549991610675894374210912905158792048420518272831056796790403546025425029784102123416456016679971331573293841474228539364603540832649658958819117389398178758330382012610370704204690379596255238286123728725406163954249985502113465818962404115494201375406759417868458414367807488335006987637672684458569893581320571348586503285138088726946175313594113191354570582162485466308813160399605423158252508345594905725149731843866587611830479049471037774239720782639308575152580381007928167120492555068628818311284363458919883192123959245266485431726851955894697364149604043077469459415999506665975571062107640324339583760761506012668701532295474271878725303810444485056282169494090591377295515827004321844080696898299901557486214379311450985302565386979031590150972344682789220730353233500659897284488079319023764529962631850160370252773270617244446982189258118635658816391280969404913076610864113013848845343726510615281523744173560783422712727002539050182582040992085646465257993005517902105688736354831461883749788856130855122861951656255396249873986626057893341120828168617884462281825444476296940728682039260827261473542120076319181659492820228842716642085148716700441474346439490178071146374700891654477541456542812325995839258714448208954310103305071735088218790158436738030522276880765360108301848693023422872955798889107987307335455179131427975011085981649171219020073869326201347429416059855313866871001854379708100219834949959983108784063817923935230889372096350801391378942927856490767614020888362091012342610321168711635042064676931658402142060122248566814917214012120389661102729734042040729416941614845408743787413931377591235857426090449033684054804043932831210560670122587117478158787048808185168496761214354889219928070443782045923818065138084762748984989813784628661768448799262792783091708130572652937615162297496742816568352910452772627040529788032524989604777136463198205905240674252898559803876422269036892775089032782478755948381153299823528475275444565604636931476100242555619360631382954529820515007017517584496220447089048821744897131401510374264293184187097009105658341499193550808901558989672743512124653851514825626220483820746676160868650621769389663111458804530789945827635162677238914115599123617511902827289815226219234311856753171680072978748153644515047871977462163379335376574807674385655380863028213995356607638171381426183862681692039022294965532701449353069844080117253355265871033263879244997959825416008931964529798250453626248601056209990117191353054247182988885225108875237290058405762717165743579154448232761630323663206259457593974960279657243291258392306192716674627239449546664706050933142393805222474761258060485808551589098060045321694893026323483383833703492929890919392010661770505584166944990470946221348218198447082111012599375284307902498711972622693323450233781571266657871138300898970378226976603752730201277005131832866043857131192527828765790136649677454331233120223063034110445911531889944909577631064632834906534335957722282330711195176663959276141925997761534607233880635472896280855735568502464899949386842696434359190381396409205994344002349714607779438411194829484906022271739532513215541940451266523402216927569591110517009156117758881512129948255949061836836810415117052924417642967293509304475218421575078380909369704699519972089886645656146241359844804955015028211781549254668638182510902704450658551827684094769206112326308473105870624556779518893031574674686926344560002062760850962808044181160810112007721874806870137726162869367697801417877130100055138119356138809396870369070268282063230267366087429573285850779434331957258021456801517879400776635485296327450226554739853655418930685167192223763910184924124307956242394489525247543068904096139638165049887927924502227662354857957071651181664980960995032094208515139506885103031559631200741694461206969507955027376780808632034972497742678623637046058850851352404971376787941673497576907578345148290311835838070797070154401801189958705878919262426891006736521380119657435447066750443883831094607484124686525785936794030117784382224098499729584106821744698230861974364320111524418151464609252213195489895316692626051197272630059919344704953887950925060413576386608744569600418610708311281329677138756289206277395126918400466925213991911026969508295782361660659632843174905845905357875851295504058105350698713347488586365346749143284930815496535802093557518170816261062894352911739788339337880872979904930494887976699167742412592970826715107626839000997487626738125407947749173208593743191641431533199653214634011248931083526049002698319134577885239492288993817343311719565458457405447549670194725802038260835625471546075563608163178272010414631613882068610006368698684720538489466120027722239563548945339217856642105086232992066840204065207727345065779296666811724409687233150724002936810953299332947133959145906789618276527406648441861678733909961376480983244126295822989284085000044900826851117123874885810514504872640108974883048614610430140982040868153144953730191502348250827459063289043531154470697203643133666705041065660000216688017524533687634046471211290316513908354718395627299951119203825135489885435972720091694810418580178794630552048609903307728862776295753955082957514865220319759419517711251613532395946196944921538969642255896855953073214110103278208830045108840659442584066018706713374589191824655931772752973788376867281096988019149931583315374427854660307110195730229535894799381246369756755030925227647303331912674418691416416603680965594011456142865851455154872459174094723283219463634483188408540732132808179480491043061450454777274483719292910447346520822329196928040020433841646630310777642143054382535753063590143816409050200895642582637088109628988303734228414207387782258250025501706932675435498752033086909392780085422259658510193660841331450728558944400041670627767417563299914379435258677589708542553765304007532651849123229737489794943038732438551331704924228914814021350760855128368881669610407676530105203397168120169576844843775713855795503620885610948854458910334840671372921219955946249900866642850410107351580999041567195300830758002265159072081310345309758044347190888302278858463297901326355626078114924164898343842623728259267409322812913800357884713477551046261905571825549066483710884968968987328421462697638361280378444634604313291626946372899995811563324182939741436078777771562561480452727204588228709739742804287144111895461785617307357840403870205210723135848966553498952235716632143731420621684401120519090230382782618239088895688722065483752204677686783375178466847581719683936533051221257502475144636982949903891971457795869963583523645304960816474256219581545277728572135834164577151705406941679429123239852495689589385589993691891264765404594728347006861566388231396495640026581702405756949611720377920091803491948111261465428975358170577735957619941390481362013251222880029966827161779474493688129897714148335375832826448410747308134660372784995821830949571918327731195014181162351849799004429598501891271165028631628928120268566980845596715879318517970401527691293363281465363856692015534571752569800137749129278549928831808068067344675628983194065883574588310122108259030800318787703327858651354859115098960093316547159307981880467087289298753654545083747255095065953616380650672282172866168475543477990443073526190604091804877389265405790587988966027155178162429769116987639749011841828134419044938192526153883506681967397718727400629947457955992720037253000349858580175862379995645927424613284595992327165145200224577967295302836091951540084241667898729319294672928578088998650792454183814747411544102645631915726455183825572108595725906377231119609456321421728265607170800320111151373711583571955798395805313185242566014450702803051947138601458030784422233737009480804344348884103476000502722000989068238648663336688486251926197624793924404717716791175663370389666253307154706488759871366430538354084498069149069717827625165362733817858953618105271121276239322612127873876823635427091859768634465824472524917736788405779963387122339730859769553026236455325053479957617632020941303084670031342707489634172468629325062380582080304525854208198570144837686658014555589508223275104353127178632653272098762436803675025637769542337950958967535328169685507246148039084366435970992521333180695851632684785341895679814125846333070074570039502649627607674141789277850941774078171447162012261257293329420012208704231557853226864429310622823765193885852569044218053376829951526683109842271162509233116156546940231628012016691524266260779975686541307439913419141694771572185298377716757478478331108527154602584487283208125103473784671273137708731703292415643751483448729051628286975265522683505414753509844552575564529530308630683171427547045460670806752728408516068514529499372435647333902706821354756842262742263974746445783610550125624555432824988824802414251908639983493149491785165227425651111070160808287889114591989109271216974502678925872717881664197929603239166260859441929588257078777992530737856527615354337519177004432929164861880330019377594732315467120633673420773790456541883019090445488005470998507340429431988113089627684372760257599801641867152641472738811982848527436588001227483801159026192597090661496395605136602179345747604469640977725946260739379765281315809563124779556970730051382128463591472050661817526543569822379496864493736172680767928352255211577293148944569649865374886125102441013910336929338954367363822865747089631672701096292822199920286781191599532581293762590050078301847266022152141265726634786756299386760495160070105579565511501857208078841012685878654129272322063645758496305358613725498474551263704451308532017113698995440571818301860990851934947296662874472699110897803197336816724353827119312079039340850737726964739174258925049518063553626369955176553153480965116273004207299171011406518439915350668528447567447172117018807167954206953341289577281662219300605130431214928039305433999464746930474346913191029118986196333288012423198698266360270301057303684357656052686651869511701522337395418251160112371367421081712162499038806296129237438805155326570534039396775135123049393518056213729793738586631908704195375054274403232321862348500399418579369880069392484651376821330226608754824512352517317882473456342291052847789025263435669580553842342905774705910038673518437816012097267475573456361220509565140873576899007037851574999673389571817225951086168245354121908695224267434866313567580324024674474046676632829412857184371955220316465443995830125743736373501963331075490026041760667808707279540526727618197052989065256293116131093009646972858990781226514800993825776681036445867288953367710075935951619239967151614055519071937576452389319224446089098551200549910337167085164590672085668852636956137650790901493383755795530812076865025687625622633712409217234578816459317252348841533840594855860176259039709357427097246473220826433162558534303091923188705186913514891984615778411039080164632819439182500050910475006213471279497671084960899362766061343703862982671578404247210616399904041169006846999864301925269955624913316609361163649127049629251698663852390813769636892890496858972126032338953326485250462952644742219390738967648964632820792449015350811228574936535671447409791213981305585376911689024093309706757068053293290084679276976515439749907222600988431187471090423852373442956530833771208189856580113233767615275313381021481785021098330445937757353937263305029835402999800133274689092240525561403851397412451081857890389437556008612260043656574851734097496961653897146889556488157468205421649740539047661609821920964027802588049262489600318673340425316635355759505931926945153788653080871778534587901375721661252532526574784174654605095820199864226777955615628673457582897536747372935497057555474807094945743288435535641425929012541761957275856288142385010282296009814111216194458599584882942125704494059741399738455352683547026517205817807751414908736155752844770667401384179232702018467174607973087812143761905115106760729451790014613544245056156358942112962342757114902115382088645850858048298867176792187358642723393908502599462062065608873909003859687641684766242531651481189018853885554614249604353831563671440174341077546512035974266011011822755647683583280561682819247641695274786027861556857109090444735119649332501217508569752208291322724455284811828608911161712636361870460815587783229804232584801030149828136886406460731219909757241998388613128910665094271114730637032023400643101381575433504125763055771794298820641973968166097933048702061004889359863558295318206857898258108240723203391342444281612738811880609104372425759866185712462044836892730578194889280303973246367763924889645181567171828087372386038082917925387757814069964339737393868896172427981069183585653308609596414439268269511293050966287542313356918155594393021544936000587163092535292620448558014627262705044134125902251871748946268372984994565569593289170897925865810524116130497177414041758778268952166689306341878484816498656017831462639082696623641855504973761097467886631735125332244358710102381219985822758891269991254783796918058043426311412192535763346605880396928474780890196056061897951962518504111701947074873113651560627363804014303351387654563637649175083421442361613112896078245009074178845390716764385070151385668191279718531199480782633418580087992551953660750435006721758056591346137724526155459467067707365337469038071419419374644647476600988180246478548637518093052654190356812534529657787293793186438339042212723459514148752296123202662209823384542637218808290029685732847269433965784836360968730461077729119619678547672981370961646028535606287874880863615645357558988012412978302497905033086011268896750093503508414086626744973741266475123290464720963864048755193781829566744359107353985206471430371026782196805478127506561404626603511508538792405258847821890647075820251897929883625127345985934168501335199606912546911197119257024562829165112049683566611290481016900131977511975037202671721249865568975544013684593183891033079125965921183220093157814429684109723660836351209119630336176063566160522891988889355836024864292801967221357366825949745193458517573612446160231644052578028728918004603291647333418531142529119851581244609490471251150223541583024005578761951550937092242034615045598482814052616275585943818922826291604162175476243249079717539394742851763672305210138761853835424174643830011663954226645587144770143881225522583745144198809860500555496313228042654869487763932826660105268458165812801855889849617112262366880323609602714065015672647877843135286319240885225619401888215552261277818142588912788113203118492050908409542372280840310466742541002754242069140019156018778530658771440957153017554299326806007124761191514383218764342624445620931716777887014352863879946025323182847674340568800240798971761992463718944949717553168710154013868198440680757544385456740602761676288788229969943461532325922684118210029628567899401391903353878083115805712713822111094625369142994899270641109355881550368113335274445938180692257413659774208557522180181998320887643589023527241670759432323666248728862535710871101601015972249328795448271004256476053453439829979454497025962574567394978552841585737333940354519588815716311818665017108262599893162237055383304929581638238768466551795399146024196206018342003391437583233884540159057830383825042107783677077918630334801011447634802061242008760486022375955408504656146473150259218744912107360075033192328472295418660782448819505743464135952256240856053478513114611351863025291500095751513063709651642823148060946294985023821671231531464005092219373403780615297062747665825364963482362718065653250165098626422862957906704634087978107857069893285772148536743649804996184958974453267373647599161751274081617311298643810979275571099062334795870541598940904798306595068717381028211728193069028365792948878734365705423687121598571791956353087900226177696838327033346427385721661913489005603600747432916018336165945417431218370077308106873320091009971249374752045114083191600500348190723678575286916007341729908115883440170272714254327536646986268461407642548969002881059083390748763890918913066330281981987445445602039309305452455663024206935372333652262943687220051035726495900300045907390932635479178688262962971669388749047962319909332142411995588726880370156721798217896146839267878518637947881886220084233458240399445253219743854028048211611030630200219609992088294582078902060625328229453473679946630070073485483093985266330540865881350474898150113479017859349558231601728799985129634417694858501643092559712158255537223892172420698811071700268944380489087649042178568818996265434021347932942229863793579955323190976372386353800350055803567649248775747662966559001758052867985154053176011699557969248591320642553891621648696259381681945101342109464942634509994383802079106611694081456163386317252187772038295379888275347242864167214750263148752633509332958373507793143110201701253620010239654973615561185335531308201669557142048500266506783174769522048259589473502002326997955607491860050915219741342184307194230356504028562433295086068150257200480594076857231968579633204286859698177834719364384568938246071808659754463686619828374529349215116637451426277664712031618019188365060415598795296925195803766683587661841931682927148823971756592951701886106016296683643495653207547524505995406937505807034621584166440076161618424328693173635979621008548750771573578372701035435003213063652813857766500271839034357075375731763504732843068021922591526149525296140625514731575524705718114307864969153007888780993336175423798384997867793049704791073591655061228334263515831512773212009679988359097411736418402390309904062589124902630845013149717258323213047593286020345387900564589334979363493642327993589900588568026198471802556500874856385115269066435152324585502221196736543134459557240107445864628165774117498888120232473043255435117006026902942905531683728554143539936870999240515094863623989766771613519384719161244331664928184190701296715871635485806036630702580028642991036354913816777438641395539391315543508998299822862737901672321385079212939786749741885866438371202598217128940512514327011017241378480595179369428567357369470911067166955305072313156379993966137309343472891992686272936390854840980944866129350002885395016644738026167790985274133556813062657329772160259027543441695162315438982024690283549882965547160082865334664759235433931397165571664601010531767004495736101296402889141186394686765847720145203393021806517961819825675304550762987059690198829933867725631136062613962129050385407637031745297383525126478882850432236855538290135436823471428793362011230967904886309889728476768597800799652226644937926693044209385090275938552019439290677910664211168491280374897222101918223533657885423280108021007540840692105042636456091785997275807144701330217564700086699884782570472617793021978493282112663168342285770608287544573259664637941738060800602651902953548475032317681831676118303347009038262356387886856965844544608122845164156055658296140853523258605078456642169835519968401190210624329463636818986279600888145694651805218339461996307707878062561757647805896003158016000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000)

; Okay, here goes the two test cases.
(test "val-of-cbv (f (! 10000))"
  (val-of-cbv test-exp (empty-env))
  test-result)

;;(test "val-of-cbneed (f (! 10000))"
;;  (val-of-cbneed test-exp (empty-env))
;;  test-result)

; I measured the time with a naive approach using a stop watch. It gave me nearly equal results, oh!
; I am not convinced yet, cuz I can't find an explanation for this. So I will try to use the ref-rand
; and lazy-rand macros to get the same behaviour out of Chez scheme. I want to check whether ! is called
; twice in call by need. I am telling it should not. I can't check this with my interpreters since
; they just support singly body lambdas

(define-syntax ref-rand
  (syntax-rules ()
    ((_ (x ...)) (box (x ...)))
    ((_ x) (if (box? x) x (box x)))))

(define-syntax lazy-rand
  (syntax-rules ()
    ((_ (x ...)) (box (lambda () (x ...))))
    ((_ x) (if (box? x) x (box (lambda () x))))))

(define unbox*
  (lambda (y-box)
    (let ((v ((unbox y-box))))
      (set-box! y-box (lambda () v))
      v)))

; I will define ! in the usual direct style
(define !
  (lambda (n)
    (if (zero? n)
      (begin (printf "\n*******\ncall to !\n*******\n") 1)
      (* n (! (sub1 n))))))

; Now, I will define call by value function cbv-f
(define cbv-f
  (lambda ()
    (let ([f (lambda (x) (+ x x))])
      (f (! 10000)))))

; Next, I will define call by need function cbn-f
(define cbn-f
  (lambda ()
    (let ([f (lambda (x) (+ (unbox* x) (unbox* x)))])
      (f (lazy-rand (! 10000))))))

; Oh! BOY!, We are talking about call-by-VALUE vs call-by-NEED. In your mind you were thinking
; of call-by-NAME vs call-by-NEED. What you said and what you thought is correct for this and 
; not call-by-VALUE vs call-by-NEED. Let's see

; Here goes the call-by-NAME function cbnm-f
; Note: unbox instead of unbox*. 
; Now you should see two calls to ! function
(define cbnm-f
  (lambda ()
    (let ([f (lambda (x) (+ ((unbox x)) ((unbox x))))])
      (f (lazy-rand (! 10000))))))

; Cool! everything is as expected. But I got a problem. I tried to do this with my own 
; call-by-name interpreter without boxes (mid2-bonus.scm), then I noticed it's really slow.
; Then I tried using the call-by-name interpreter with boxes (a5.scm). Weird, it too is
; slow. Now, I am thinking of replicate the exact thing on top of scheme with lazy-rand
; and ((unbox x))

(define cbnm-f-2
  (lambda ()
    ((lambda (x) (+ ((unbox x)) ((unbox x))))
     (lazy-rand ((lambda (!)
                   ((((unbox !)) (lazy-rand ((unbox !)))) (lazy-rand 10000)))
                 (lazy-rand (lambda (!)
                              (lambda (n)
                                (if (zero? ((unbox n)))
                                  1
                                  (* ((unbox n)) ((((unbox !)) (lazy-rand ((unbox !)))) (lazy-rand (sub1 ((unbox n)))))))))))))))

; Aha! this is now slow as my own interpreters. May be not that slow cuz this may not require that
; many method calls. 





 
  